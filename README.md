# GATEKeeper
Gatekeeper defines phylogenetic relationships by performing pairwise alignments across all input sequences, then contructing a minimum spanning tree based on relative sequence similarities. GATEKeeper is currently only available for linux based operating systems. 
*** INSERT WORKFLOW IMAGE HERE ***

## Installation
To install GATEKeeper, please run the following series of commands within a linux terminal:
```
git clone https://github.com/aliciapetrany/GATEKeeper.git
cd GATEKeeper
make
chmod +x run_GATEKeeper.py
chmod +x bin/GATEkeeper
```
## Requirements
The following are required for the python portion of the pipeline to function:
```
numpy>=1.26.2
pandas>=2.1.4
scipy>=1.11.4
```
The following are required for the c++ portion of the pipeline to function:

BWA (http://bio-bwa.sourceforge.net/) is required for sequence alignments. The conda based installation is as follows: 
```
conda install -c bioconda bwa
```
## Usages
GATEKeeper is available for use under python and command line implementations. The full pipeline can be run from both python and the command line, however, single rapid pairwise alignments can only be run from the command line at this time.
### Python Usage
#### GATEKeeper Initialization and Running
All of GATEKeeper's python functionality is encompassed within the GATEKeeper class. Upon initialization, a path to a valid fasta file must be provided, then GATEKeeper must be run manually:
```
from GATEKeeperUtils import GATEKeeper
g = GATEKeeper("../Selected_1000_Genomes.fasta")
g.run()
```
GATEKeeper has optional attributes that can be adjusted with the following syntax prior to running it:
```
from GATEKeeperUtils import GATEKeeper
g = GATEKeeper("../Selected_1000_Genomes.fasta")
g.trial_name = "test_trial"
g.vcf_level = 2
g.run()
```
The exhaustive list of GATEKeeper attributes is as follows:  
  - `trial_name` [string] The suffix to be added to each output file.
  - `vcf_level` [int] The level of detail in vcf outputs. 0 = No VCF output, 1 = Root vs. all VCF output, and 2 = all vs. all VCF output. 
  - `bin_path` [string] Path to the 'bin' directory within the GATEKeeper directory. Must change if working outside of the GATEKeeper directory
  - `nperms` [int] The number of permutations run when resampling the minimum spanning tree
  - `nthreads` [int] The number of threads to run GATEKeeper calls across
  - `verbosity` [int] Level of verbosity in the output. 0 = No outputs, 1 = warnings only, 2 = warnings and messages
  - `seq_limit` [int] The number of sequences to cut the alignments off at, if neceessary. If specified, GATKeeper will only read in 'seq_limit" number of sequences, then truncate the remaining sequences in the fasta file. 
  - `root_pos` [int] Position of the root sequence in the fasta file, defaults to the first sequence. Only necessary if 'vcf_level' = 1, or if running GATEKeeper in test mode 
  - `test_mode` [boolean] If true, runs time series validation of the final minimum spanning tree. For this mode to work properly, a 'root_pos' and 'time_metadata_path' must be properly defined
  - `time_metadata_path` [string] Path to NCBI file containing information for each sequence. For more information about this file, please refer to the "Notes" section of this readme file.
#### GATEKeeper Outputs
For python, GATEKeeper resutls are available in two locations; The first is within the GATEKeeper object, and the second is within the 'output_files' directory that is automatically generated by GATEKeeper.    
The following attributes can be used to access the results within python. The corresponding file name within the 'output_file' directory is shown in brackets for each attribute:
- `.adj_mat` [mutation_matrix.csv] An adjacency matrix containing the number of mutations between all genomes
- `.mst` [minimum_spanning_tree.csv] The minimum spanning tree with confidence levels in the format of an adjacency matrix
- `.interaction_df` [cytoscape_output.csv] The minimum spanning tree in a condensed Pandas DataFrame. Can be imported into cytoscape or similar software for visualization
- `.vcf_df` ['trial_name'.vcf] The vcf file in the format of a Pandas DataFrame
- `.time_series_df` ['time_validation_results] The time difference in months between two interacting genomes formatted into a Pandas DataFrame (only available after test mode)

### Command Line Usage
GATEKeeper can be run from two avenues on the commmand line. The first runs the entire pipeline, while the second runs a rapid pairwise alignment between two genomes. 
#### Pairwise Alignment Usage
GATEKeeper can be called to align two sequences with the following:
```
bin/GATEkeeper -r <fasta file 1> -q <fasta file 2> -o <trial name>
```
For more information and parameters, please run `bin/GATEKeeper -h`
#### Full Pipeline Usage
To run the entire pipeline, please run the following:
```
./run_GATEKeeper.py -f <path to fasta file>
```
You can pass all of the arguments from the single GATEKeeper call, as well as the following arguments which mirror the attributes described in the python section. The following flags corresponds to each attribute:
- `-f` or `--fastafile` for the fasta file name
- `-o` or `--output` for `trial_name`
- `-r` or `--root_pos` for `root_pos`
- `-n` or `--nperms` for `nperms`
- `-v` or `--vcfformat` for `vcf_level`
- `-m` or `--metadata` for `time_metadata_path`
- `x` or `--testmode` for `test_mode`
- `-l` or `--seqlimit` for `seq_limit`
- `-t` or `--threads` for `nthreads`
- `-p` or `--binpath` for `binpath`
- `-verb` or `--verbosity` for `verbosity`
  
The output files will be present in the output_files folder.

## Notes
#### Time metadata file
If running in test mode to validate the chronology of the minimum spanning tree, a file containing collection date metadata from the NCBI must be provided. The file must be a csv in the format of the entry seen here: https://www.ncbi.nlm.nih.gov/labs/virus/vssi/#/virus?SeqType_s=Nucleotide&VirusLineage_ss=Severe%20acute%20respiratory%20syndrome%20coronavirus%202,%20taxid:2697049, with at least the "Accession" and "Collection_Date" columns present.  
